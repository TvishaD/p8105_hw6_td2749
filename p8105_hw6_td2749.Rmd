---
title: "p8105_hw6_td2749"
author: "Tvisha R. Devavarapu"
date: "2022-11-22"
output: github_document
---

```{r setup, message = FALSE}
library(tidyverse)
library(ggplot2)
library(modelr)
library(mgcv)

knitr::opts_chunk$set(
  fig.width = 10,
  fig.asp = .6,
  out.width = "90%")
```

# Problem 2

```{r homicide_data set up}
homicide_data = 
  read_csv("./data/homicide-data.csv") %>%
  janitor::clean_names() %>% 
  unite(city_state, c(city, state), sep = ",", remove = FALSE) %>% 
  mutate(
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age),
    victim_sex = as.factor(victim_sex)) %>% 
  filter(
    !(city_state %in% c("Dallas,TX", "Phoenix,AZ", "Kansas City,MO", "Tulsa,AL")),
    victim_race %in% c("White", "Black")) %>% 
  mutate(
    victim_race = as.factor(victim_race))

head(homicide_data)
```

**Note**: In the `homicide_data` df, column `resolved` indicates the case status. Cases that are closed by arrest (solved cases) are represented by 1 and cases that are open/no-arrest and closed without arrest (unsolved cases) are represented by 0. 

```{r blatimore glm for logistic fit}
balt_log_fit = 
  homicide_data %>% 
  filter(
    city_state == "Baltimore,MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

balt_log_fit_table = broom::tidy(balt_log_fit)

balt_log_fit_table %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)

male_vic_OR = exp(coef(balt_log_fit))[["victim_sexMale"]]
male_vic_OR_lower = exp(confint(balt_log_fit, "victim_sexMale"))[[1]]
male_vic_OR_upper = exp(confint(balt_log_fit, "victim_sexMale"))[[2]]
```

**OR**: `r male_vic_OR`

**95% Confidence Interval**: (`r male_vic_OR_lower`, `r male_vic_OR_upper`)

The above odds ratio indicates that controlling all other variables, the odds of a homicide being solved is ~57.4% lower (between 44.2% and 67.6%) for a male victim compared to a female victim (in the case of Baltimore, MA between 2007 and 2017).

```{r glm for all cities, message = FALSE}
hom_all_glm = 
  homicide_data %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    ci = map_df(.x = models, ~confint(object = .x, parm = "victim_sexMale")), 
    results = map(models, broom::tidy)) %>% 
  select(-data, -models) %>% 
  unnest(results) %>% 
  unnest(ci) %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(OR = exp(estimate),
         ci_lower = exp(`2.5 %`),
         ci_upper = exp(`97.5 %`)) %>% 
  select(city_state, term, OR, ci_lower, ci_upper)

head(hom_all_glm)
```

```{r all cities plot}
male_female_odds_plot = 
  hom_all_glm %>%
    ggplot(aes(x = reorder(city_state, OR), y = OR)) +
      geom_point() +
      geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper)) +
      labs(title = "Comparative Odds: Solved Homicides of Male Victims in reference to Female Victims",
           x = "Location (City and State)",
           y = "Comparative Odds",
           caption = "Comparative odds of solved homicides of male victims in reference to female victims with associated 95% confidence intervals between 2007 and 2017 in major US cities.") +
      theme(plot.title = element_text(hjust = 0.5, face = "bold"),
            plot.caption = element_text(hjust = 0.5),
            axis.title = element_text(face = "bold"),
            axis.text.x = element_text(angle = 70, hjust = 1))

male_female_odds_plot
```

**Comment**: Based on the fit model, compared to female homicide victim cases, male homicide victim cases are less likely to be solved in New York, NY. More likely in Albuqurque, NM. (ASK ABOUT LIKELIHOOD OF THE VICTIM BEING MALE/FEMALE IN THE FIRST PLACE). 


# Problem 3

```{r birthweight data setup}
birthweight_data = 
  read_csv("./data/birthweight.csv") %>%
  janitor::clean_names() %>% 
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    malform = as.factor(malform),
    mrace = as.factor(mrace))
```

* There are no missing values in this dataset (`r sum(is.na(birthweight_data))`). 

??? Describe your modeling process ??? 

`mrace`: (1 = White, 2 = Black, 3 = Asian, 4 = Puerto Rican, 8 = Other)
`momage`: Ranging from 12 - 44. 

```{r linear model suggestion}
bwt_momage_mrace_scatter = 
  birthweight_data %>% 
    ggplot(aes(x = momage, y = bwt, color = mrace)) +
    geom_point(aes(alpha = 0.3))

bwt_momage_mrace_scatter
```

```{r my_model fit}
my_model = 
  birthweight_data %>% 
  lm(bwt ~ momage + mrace, data = .)

summary(my_model)

```

```{r residuals vs. fitted values plot}
birthweight_data %>% 
  select(momage, mrace, bwt) %>% 
  modelr::add_residuals(., my_model) %>% 
  modelr::add_predictions(., my_model) %>% 
    ggplot(aes(x = pred, y = resid)) +
    geom_point() +
    geom_hline(yintercept = 0)

```

```{r setting up given models}
# One using length at birth and gestational age as predictors (main effects only)
blength_gaweeks_fit = 
  birthweight_data %>% 
  lm(bwt ~ blength + gaweeks, data = .)

summary(blength_gaweeks_fit)

# One using head circumference, length, sex, and all interactions (including the three-way interaction) between these
bhead_blength_babysex_fit = 
  birthweight_data %>% 
  lm(bwt ~ bhead + blength + babysex + bhead*blength*babysex, data = .)

summary(bhead_blength_babysex_fit)
```

Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.

```{r cross validation}
cv_df = 
  crossv_mc(birthweight_data, 100)

cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(
    my_mod = map(train, ~lm(bwt ~ momage + mrace, data = .x)),
    blength_gaweeks_mod = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    bhead_blength_babysex_mod = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength*babysex, data = .x))) %>% 
  mutate(
    rmse_my_mod = map2_dbl(my_mod, test, ~rmse(model = .x, data = .y)),
    rmse_blength_gaweeks_mod = map2_dbl(blength_gaweeks_mod, test, ~rmse(model = .x, data = .y)),
    rmse_bhead_blength_babysex_mod = map2_dbl(bhead_blength_babysex_mod, test, ~rmse(model = .x, data = .y)))
```

```{r plotting}
cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
```





